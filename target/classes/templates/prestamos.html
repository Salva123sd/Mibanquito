<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Préstamos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/prestamos.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
</head>

<body>
    <div th:replace="~{fragments/navbar :: body}"></div>

    <div class="container mt-3">
        <div th:if="${mensaje}" class="alert alert-dismissible fade show" th:classappend="' alert-' + ${clase}"
            role="alert">
            <span th:text="${mensaje}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <div class="container mt-4">

        <!-- Formulario -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
                <i class="bi bi-plus-circle"></i>
                <h5 class="mb-0">Registrar Préstamo</h5>
            </div>
            <div class="card-body">
                <form th:action="@{/prestamos/registrar}" method="post" id="formPrestamo">
                    <div class="row g-3">
                        <div class="col-lg-3">
                            <label class="form-label">Persona</label>
                            <select class="form-select" name="dni" required>
                                <option value="" disabled selected>Seleccione persona</option>
                                <option th:each="persona : ${personas}" th:value="${persona.dni}"
                                    th:text="${persona.nombres + ' ' + persona.apellidos}"></option>
                            </select>
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label">Objeto</label>
                            <select class="form-select" name="objetoId" id="objetoSelect" required
                                onchange="calcularTotal()">
                                <option value="" disabled selected data-monto="0">Seleccione objeto</option>
                                <option th:each="objeto : ${objetos}" th:value="${objeto.id}"
                                    th:data-monto="${objeto.monto ?: 0}"
                                    th:text="'S/ ' + ${#numbers.formatDecimal(objeto.monto ?: 0, 1, 'POINT', 2, 'COMMA')} + ' (' + objeto.estado + ')'">
                                </option>
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Interés (%)</label>
                            <select class="form-select" name="interesPorcentaje" id="interesSelect" required
                                onchange="calcularTotal()">
                                <option value="0">0% (Sin interés)</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Fecha Límite</label>
                            <input type="date" name="fechaLimite" class="form-control" required>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Total a Pagar</label>
                            <div class="input-group">
                                <span class="input-group-text">S/</span>
                                <input type="text" class="form-control fw-bold text-success" id="totalPagar"
                                    value="0.00" readonly style="background-color: #e8f5e9;">
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary"><i class="bi bi-save"></i> Registrar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla -->
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
                <i class="bi bi-journal-text"></i>
                <h5 class="mb-0">Historial de Préstamos</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Persona</th>
                                <th>Monto</th>
                                <th>Interés</th>
                                <th>Total a Pagar</th>
                                <th>Fecha Préstamo</th>
                                <th>Fecha Límite</th>
                                <th>Estado</th>
                                <th class="text-end">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(prestamos)}">
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="bi bi-inboxes"></i> No hay préstamos registrados.
                                </td>
                            </tr>
                            <tr th:each="prestamo : ${prestamos}">
                                <td th:text="${prestamo.id}"></td>
                                <td th:text="${prestamo.persona.nombres + ' ' + prestamo.persona.apellidos}"></td>
                                <td><strong class="text-primary">S/ <span
                                            th:text="${#numbers.formatDecimal(prestamo.objeto.monto ?: 0, 1, 'POINT', 2, 'COMMA')}"></span></strong>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark"
                                        th:text="${(prestamo.interesPorcentaje ?: 0) + '%'}"></span>
                                </td>
                                <td>
                                    <strong class="text-success">S/ <span
                                            th:text="${#numbers.formatDecimal(prestamo.totalPagar ?: 0, 1, 'POINT', 2, 'COMMA')}"></span></strong>
                                </td>
                                <td th:text="${prestamo.fechaPrestamo}"></td>
                                <td th:text="${prestamo.fechaLimite}"></td>
                                <td>
                                    <th:block th:switch="${prestamo.estado}">
                                        <span th:case="'ACTIVO'" class="badge bg-warning text-dark">
                                            <i class="bi bi-clock-history"></i> Activo
                                        </span>
                                        <span th:case="'DEVUELTO'" class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Devuelto
                                        </span>
                                        <span th:case="'VENCIDO'" class="badge bg-danger">
                                            <i class="bi bi-exclamation-triangle"></i> Vencido
                                        </span>
                                        <span th:case="'ENTREGADO ATRASADO'" class="badge bg-secondary">
                                            <i class="bi bi-arrow-left-right"></i> Entregado con retraso
                                        </span>
                                    </th:block>
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-2">
                                        <!-- Botón devolver -->
                                        <form th:if="${prestamo.estado == 'ACTIVO' or prestamo.estado == 'VENCIDO'}"
                                            th:action="@{/prestamos/devolver/{id}(id=${prestamo.id})}" method="post">
                                            <button class="btn btn-sm btn-success">
                                                <i class="bi bi-arrow-counterclockwise"></i> Devolver
                                            </button>
                                        </form>

                                        <!-- Botón detalle -->
                                        <a th:href="@{'/prestamos/' + ${prestamo.id}}"
                                            class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-search"></i> Detalle
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function calcularTotal() {
            const objetoSelect = document.getElementById('objetoSelect');
            const interesSelect = document.getElementById('interesSelect');
            const totalPagarInput = document.getElementById('totalPagar');

            const selectedOption = objetoSelect.options[objetoSelect.selectedIndex];
            const monto = parseFloat(selectedOption.dataset.monto) || 0;
            const interesPorcentaje = parseFloat(interesSelect.value) || 0;

            const interes = monto * (interesPorcentaje / 100);
            const total = monto + interes;

            totalPagarInput.value = total.toFixed(2);
        }
    </script>
</body>

</html>